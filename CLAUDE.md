# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Acts 17:11 is a Bible teaching application that layers explanations, cross-references, and geographic context onto scripture. It uses the World English Bible Protestant Edition (WEBP), a public domain translation.

## Tech Stack

- **Go 1.25** server and CLI tools
- **PostgreSQL 16+** with goose migrations and sqlc code generation
- **htmx + Alpine.js + Tailwind CSS** frontend

## Common Commands

```bash
# Database migrations
goose -dir migrations postgres "$DATABASE_URL" up
goose -dir migrations postgres "$DATABASE_URL" down

# Download USFM Bible text files from ebible.org
go run ./cmd/download-usfm/

# Parse USFM files and generate seed.sql
go run ./cmd/import-usfm/ ./usfm/engwebp/

# Generate type-safe Go code from SQL queries
sqlc generate
```

## Architecture

### Data Pipeline

Two CLI tools handle Bible text ingestion:
1. `cmd/download-usfm/` — downloads and extracts WEBP USFM archive from eBible.org, filtering out non-scripture files (front matter, glossaries, etc.)
2. `cmd/import-usfm/` — parses USFM markup into structured data and generates `seed.sql` with INSERT statements for 1 translation, 66 books, and 31,000+ verses

### Database Layer

- **Migrations** (`migrations/`): 7 goose migration files defining the schema. Tables use PostgreSQL ENUM types (`testament`, `annotation_type`, `connection_type`, `topic_category`), IDENTITY columns, CASCADE deletes, and automatic `updated_at` triggers.
- **Queries** (`sqlc/queries/`): Hand-written SQL with sqlc annotations (`:one`, `:many`, `:exec`, `:copyfrom`). These are the source of truth for database operations.
- **Generated code** (`internal/repository/`): Auto-generated by `sqlc generate` — **do not edit manually**. Uses `pgx/v5` driver.

### Content Model

Core tables: `bible_translation` → `book` → `verse`

Enrichment tables layered on top:
- `annotation` — contextual notes on verses (5 types, 2 tiers: basic and advanced)
- `connection` — cross-references between verses (6 types including typology, direct quotation, allusion)
- `topic` / `topic_passage` — thematic groupings across verse ranges
- `location` / `location_passage` — geographic data with coordinates

### Workflow for Schema Changes

1. Create a new goose migration in `migrations/`
2. Write or update queries in `sqlc/queries/`
3. Run `sqlc generate` to regenerate `internal/repository/`
